<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== リセット & ベース ===== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #faf9f6;
      color: #3d3d3d;
      padding: 24px 16px;
      max-width: 960px;
      margin: 0 auto;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== ヘッダー ===== */
    h1 {
      text-align: center;
      font-size: 1.15rem;
      font-weight: 700;
      color: #4f5d75;
      letter-spacing: 0.08em;
      margin-bottom: 28px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0dcd6;
    }

    h2 {
      font-size: 1rem;
      font-weight: 700;
      color: #5a5a5a;
    }

    /* ===== 画面切り替え ===== */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* ===== ナビバー ===== */
    .nav-bar {
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-back {
      background: transparent;
      color: #4f5d75;
      padding: 6px 14px;
      border-radius: 0;
      border: 1px solid #c8c4be;
      cursor: pointer;
      font-size: 0.85rem;
      font-family: inherit;
      transition: background 0.15s, border-color 0.15s;
    }

    .btn-back:hover {
      background: #f0ede8;
      border-color: #a8a49e;
    }

    /* ===== グリッド & タイル ===== */
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      justify-content: center;
      margin-bottom: 28px;
    }

    .tile {
      background: #fff;
      border: 1px solid #e8e4df;
      border-radius: 10px;
      padding: 20px;
      width: 340px;
      cursor: default;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
    }

    .tile-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 10px;
      width: 100%;
      text-align: center;
      border-bottom: 1px solid #ece8e3;
      padding-bottom: 10px;
      padding-right: 28px;
      box-sizing: border-box;
      cursor: pointer;
      color: #3d3d3d;
      transition: color 0.15s;
    }

    .tile-title:hover {
      color: #ef8354;
    }

    /* ===== 削除ボタン (タイル) ===== */
    .btn-delete-tile {
      position: absolute;
      top: 14px;
      right: 14px;
      background: none;
      border: none;
      color: #cbc7c1;
      padding: 0;
      font-size: 1rem;
      cursor: pointer;
      transition: color 0.15s;
      line-height: 1;
    }

    .btn-delete-tile:hover {
      color: #c0392b;
    }

    /* ===== チャート ===== */
    .chart-container {
      position: relative;
      width: 130px;
      height: 130px;
      margin: 0 auto 10px auto;
      pointer-events: none;
      cursor: pointer;
    }

    .center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.05rem;
      font-weight: 700;
      color: #5a5a5a;
    }

    /* ===== 科目内タスクリスト ===== */
    .sub-task-list {
      width: 100%;
      margin-top: 12px;
      border-top: 1px solid #ece8e3;
      padding-top: 10px;
      max-height: 240px;
      overflow-y: auto;
      cursor: default;
    }

    .sub-task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 0;
      border-bottom: 1px solid #f3f0ec;
      font-size: 0.82rem;
    }

    .sub-task-item:last-child {
      border-bottom: none;
    }

    .sub-task-name {
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 6px;
      color: #555;
    }

    .sub-task-controls {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-shrink: 0;
    }

    /* ===== タスク画面 ===== */
    .list-container {
      background: #fff;
      padding: 20px;
      border-radius: 0;
      border: 1px solid #e8e4df;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0ede8;
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-name {
      font-size: 0.95rem;
      flex-grow: 1;
      cursor: pointer;
      color: #3d3d3d;
      transition: color 0.15s;
    }

    .task-name:hover {
      text-decoration: none;
      color: #ef8354;
    }

    .task-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
    }

    .laps-badge {
      background: #f0ede8;
      color: #4f5d75;
      padding: 3px 10px;
      border-radius: 0;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .laps-badge:hover {
      background: #e4e0da;
    }

    /* ===== ボタン共通 ===== */
    button {
      border: none;
      border-radius: 0;
      padding: 6px 12px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 700;
      font-size: 0.8rem;
      transition: background 0.15s, opacity 0.15s;
    }

    button:hover {
      opacity: 0.85;
    }

    .btn-progress {
      background: #e9c46a;
      color: #5a4a1e;
      padding: 4px 8px;
    }

    .btn-done {
      background: #2d6a4f;
      color: #fff;
      padding: 4px 8px;
    }

    .btn-undo {
      background: #bdb8b0;
      color: #fff;
      font-size: 0.72rem;
      padding: 4px 6px;
    }

    .btn-delete {
      background: transparent;
      color: #cbc7c1;
      padding: 4px;
      margin-left: 4px;
      font-size: 0.9rem;
    }

    .btn-delete:hover {
      color: #c0392b;
    }

    /* ===== 入力フォーム ===== */
    .add-form {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
      background: #fff;
      padding: 14px 16px;
      border-radius: 0;
      border: 1px solid #e8e4df;
      box-shadow: none;
    }

    .add-form input {
      padding: 8px 12px;
      font-size: 0.9rem;
      font-family: inherit;
      border: 1px solid #d5d0ca;
      border-radius: 0;
      flex-grow: 1;
      max-width: 320px;
      color: #3d3d3d;
      background: #faf9f6;
      transition: border-color 0.15s;
    }

    .add-form input:focus {
      outline: none;
      border-color: #ef8354;
    }

    .add-form input::placeholder {
      color: #b5b0a8;
    }

    .btn-add {
      background: #ef8354;
      color: #fff;
      padding: 8px 18px;
      font-size: 0.85rem;
    }

    .btn-add:hover {
      background: #e0723f;
    }

    /* ===== 編集入力 ===== */
    .edit-input {
      padding: 4px 6px;
      font-size: 0.9rem;
      font-family: inherit;
      border: 1px solid #ef8354;
      border-radius: 0;
      color: #3d3d3d;
      width: 80%;
      outline: none;
    }

    .edit-lap-input {
      width: 44px;
      text-align: center;
    }

    /* ===== スクロールバー ===== */
    .sub-task-list::-webkit-scrollbar {
      width: 4px;
    }

    .sub-task-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .sub-task-list::-webkit-scrollbar-thumb {
      background: #d5d0ca;
      border-radius: 2px;
    }
  </style>
</head>

<body>

  <h1 id="main-title">SSM</h1>

  <div id="view-tests" class="view active">
    <h2>テスト・目標一覧</h2>
    <div class="grid" id="tests-grid"></div>
    <div class="add-form">
      <input type="text" id="new-test-name" placeholder="新しいテスト名 (例: 期末テスト)">
      <button class="btn-add" onclick="addTest()">追加</button>
    </div>
  </div>

  <div id="view-subjects" class="view">
    <div class="nav-bar">
      <button class="btn-back" onclick="goBackTo('tests')">◀ テスト一覧へ戻る</button>
      <h2 id="current-test-title" style="margin: 0;"></h2>
    </div>
    <div class="grid" id="subjects-grid"></div>
    <div class="add-form">
      <input type="text" id="new-subject-name" placeholder="新しい科目名 (例: 物理)">
      <button class="btn-add" onclick="addSubject()">追加</button>
    </div>
  </div>

  <div id="view-tasks" class="view">
    <div class="nav-bar">
      <button class="btn-back" onclick="goBackTo('subjects')">◀ 科目一覧へ戻る</button>
      <h2 id="current-subject-title" style="margin: 0;"></h2>
    </div>
    <div class="list-container" id="tasks-list"></div>
    <div class="add-form">
      <input type="text" id="new-task-name" placeholder="新しいタスク (例: 問題集 P10-20)">
      <button class="btn-add" onclick="addTask()">追加</button>
    </div>
  </div>

  <script>
    // --- 1. データ管理（保存機能） ---
    // LocalStorageからデータを読み込む（なければ初期データ）
    const STORAGE_KEY = 'studyAppLapsDataV2';
    let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
      {
        id: "t1", name: "1学期 中間テスト",
        subjects: [
          {
            id: "s1", name: "数学",
            tasks: [
              { id: "tk1", name: "FG", laps: 0, inProgress: false },
            ]
          }
        ]
      }
    ];

    // データを保存する関数
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    // --- 2. 状態管理 ---
    let currentTestId = null;
    let currentSubjectId = null;
    let charts = {}; // チャートのインスタンス管理

    // --- 3. 画面遷移と描画ロジック ---
    function switchView(viewId) {
      document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
      document.getElementById('view-' + viewId).classList.add('active');
      window.scrollTo(0, 0);
    }

    function goBackTo(target) {
      if (target === 'tests') {
        currentTestId = null;
        renderTests();
        switchView('tests');
      }
      if (target === 'subjects') {
        currentSubjectId = null;
        renderSubjects();
        switchView('subjects');
      }
    }

    // ID生成用ユーティリティ
    function generateId() {
      return Math.random().toString(36).substring(2, 9);
    }

    // 【テスト画面】の描画
    function renderTests() {
      const grid = document.getElementById('tests-grid');
      grid.innerHTML = '';
      appData.forEach(test => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.innerHTML = `
          <button class="btn-delete-tile" onclick="deleteTest(event, '${test.id}')" title="このテストを削除">×</button>
          <div class="tile-title" onclick="openTest('${test.id}')">${test.name}</div>
          <p onclick="openTest('${test.id}')" style="width:100%; text-align:center; cursor:pointer; color:#7a7a7a; font-size:0.85rem;">${test.subjects.length} 科目</p>
        `;
        grid.appendChild(tile);
      });
    }

    window.openTest = function (testId) {
      const test = appData.find(t => t.id === testId);
      currentTestId = testId;
      document.getElementById('current-test-title').innerText = test.name;
      renderSubjects();
      switchView('subjects');
    };

    // 【科目画面】の描画（円グラフ付き）
    function renderSubjects() {
      const grid = document.getElementById('subjects-grid');
      grid.innerHTML = '';

      const test = appData.find(t => t.id === currentTestId);
      if (!test) return;

      // 科目タイルの描画
      test.subjects.forEach(subject => {
        // x（最低周回数）を計算。タスクが0個の場合は0周目とする。
        const x = subject.tasks.length > 0 ? Math.min(...subject.tasks.map(t => t.laps)) : 0;
        const targetLap = x + 1;

        let achievedCount = 0,
          inProgressCount = 0,
          unachievedCount = 0;
        subject.tasks.forEach(task => {
          if (task.laps >= targetLap) achievedCount++;
          else if (task.inProgress) inProgressCount++;
          else unachievedCount++;
        });

        // グラフが全て0（タスク無し）の場合は未達成1としてグレーで描画
        if (subject.tasks.length === 0) unachievedCount = 1;

        const tile = document.createElement('div');
        tile.className = 'tile';

        // タスクリストの構築
        let taskListHtml = '<div class="sub-task-list">';
        if (subject.tasks.length === 0) {
          taskListHtml += '<p style="color:#b5b0a8; font-size:0.8rem; text-align:center;">タスクなし</p>';
        } else {
          subject.tasks.forEach(task => {
            const statusStyle = task.inProgress ? 'color:#c48531;' : '';
            taskListHtml += `
              <div class="sub-task-item">
                <span class="sub-task-name" style="${statusStyle}">${task.name}</span>
                <div class="sub-task-controls">
                  <span style="font-weight:700; margin-right:5px; color:#4f5d75;">${task.laps}</span>
                  <button class="btn-progress" style="padding: 4px 6px;" onclick="toggleProgress(event, '${task.id}', '${subject.id}')">${task.inProgress ? '中断' : '着手'}</button>
                  <button class="btn-undo" onclick="removeLap(event, '${task.id}', '${subject.id}')" title="1周減らす">取消</button>
                  <button class="btn-done" style="padding: 4px 6px;" onclick="addLap(event, '${task.id}', '${subject.id}')" title="1周増やす">完了</button>
                </div>
              </div>
            `;
          });
        }
        taskListHtml += '</div>';

        tile.innerHTML = `
          <button class="btn-delete-tile" onclick="deleteSubject(event, '${subject.id}')" title="この科目を削除">×</button>
          <div class="tile-title" onclick="openSubject('${subject.id}')" title="詳細/編集を開く">${subject.name}</div>
          <div class="chart-container" onclick="openSubject('${subject.id}')" title="詳細/編集を開く">
            <canvas id="chart-${subject.id}"></canvas>
            <div class="center-text">${x}周目</div>
          </div>
          ${taskListHtml}
        `;
        grid.appendChild(tile);

        // Chart.jsの描画
        const ctx = document.getElementById(`chart-${subject.id}`).getContext('2d');
        if (charts[subject.id]) charts[subject.id].destroy();

        // 色の設定（新パレット）
        const themeColors = {
          0: ['#ef8354', '#f5cdb6'],
          1: ['#4f5d75', '#b8c0cc'],
          2: ['#2d6a4f', '#a7c4b5']
        };
        const colors = themeColors[x % 3] || ['#7b6b8d', '#c9c0d3'];

        charts[subject.id] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['達成', 'やり途中', '未達成'],
            datasets: [{
              data: [achievedCount, inProgressCount, unachievedCount],
              backgroundColor: [colors[0], colors[1], '#e8e4df'],
              borderWidth: 0
            }]
          },
          options: {
            cutout: '75%',
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                enabled: true
              }
            }
          }
        });
      });
    }

    window.openSubject = function (subjectId) {
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === subjectId);
      currentSubjectId = subjectId;
      document.getElementById('current-subject-title').innerText = `${test.name} > ${subject.name}`;
      renderTasks();
      switchView('tasks');
    };

    // 【タスク画面】の描画
    function renderTasks() {
      const list = document.getElementById('tasks-list');
      list.innerHTML = '';
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === currentSubjectId);

      if (subject.tasks.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#b5b0a8;">タスクがありません。下から追加してください。</p>';
        return;
      }

      subject.tasks.forEach(task => {
        const item = document.createElement('div');
        item.className = 'task-item';
        const statusText = task.inProgress ? '<span style="color:#c48531; font-size:0.8rem; margin-left:10px;">(進行中)</span>' : '';

        item.innerHTML = `
          <div class="task-name" id="name-${task.id}" onclick="editTaskName('${task.id}')">${task.name} ${statusText}</div>
          <div class="task-controls">
            <span class="laps-badge" id="laps-${task.id}" onclick="editTaskLaps('${task.id}')">${task.laps}周</span>
            <button class="btn-progress" onclick="toggleProgress(event, '${task.id}', '${subject.id}')">${task.inProgress ? '中断' : '着手'}</button>
            <button class="btn-done" onclick="addLap(event, '${task.id}', '${subject.id}')">完了 (+1周)</button>
            <button class="btn-delete" onclick="deleteTask('${task.id}')">×</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // --- 4. 編集・削除ロジック ---
    window.editTaskName = function (taskId) {
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === currentSubjectId);
      const task = subject.tasks.find(t => t.id === taskId);
      const el = document.getElementById(`name-${taskId}`);

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'edit-input';
      input.value = task.name;
      input.onblur = () => {
        if (input.value.trim()) {
          task.name = input.value.trim();
          saveData();
        }
        renderTasks();
      };
      input.onkeydown = (e) => {
        if (e.key === 'Enter') input.blur();
      };

      el.innerHTML = '';
      el.appendChild(input);
      input.focus();
    };

    window.editTaskLaps = function (taskId) {
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === currentSubjectId);
      const task = subject.tasks.find(t => t.id === taskId);
      const el = document.getElementById(`laps-${taskId}`);

      const input = document.createElement('input');
      input.type = 'number';
      input.className = 'edit-input edit-lap-input';
      input.value = task.laps;
      input.onblur = () => {
        const val = parseInt(input.value);
        if (!isNaN(val)) {
          task.laps = val;
          saveData();
        }
        renderTasks();
      };
      input.onkeydown = (e) => {
        if (e.key === 'Enter') input.blur();
      };

      el.innerHTML = '';
      el.appendChild(input);
      input.focus();
    };

    window.deleteTask = function (taskId) {
      if (!confirm('このタスクを削除しますか？')) return;
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === currentSubjectId);
      subject.tasks = subject.tasks.filter(t => t.id !== taskId);
      saveData();
      renderTasks();
    };

    window.deleteSubject = function (event, subjectId) {
      event.stopPropagation();
      if (!confirm('この科目を削除しますか？')) return;
      const test = appData.find(t => t.id === currentTestId);
      test.subjects = test.subjects.filter(s => s.id !== subjectId);
      saveData();
      renderSubjects();
    };

    window.deleteTest = function (event, testId) {
      event.stopPropagation();
      if (!confirm('このテストを削除しますか？')) return;
      appData = appData.filter(t => t.id !== testId);
      saveData();
      renderTests();
    };

    // --- 5. データ追加ロジック ---
    window.addTest = function () {
      const input = document.getElementById('new-test-name');
      if (!input.value.trim()) return;
      appData.push({
        id: generateId(),
        name: input.value.trim(),
        subjects: []
      });
      input.value = '';
      saveData();
      renderTests();
    };

    window.addSubject = function () {
      const input = document.getElementById('new-subject-name');
      if (!input.value.trim()) return;
      const test = appData.find(t => t.id === currentTestId);
      test.subjects.push({
        id: generateId(),
        name: input.value.trim(),
        tasks: []
      });
      input.value = '';
      saveData();
      renderSubjects();
    };

    window.addTask = function () {
      const input = document.getElementById('new-task-name');
      if (!input.value.trim()) return;
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === currentSubjectId);
      subject.tasks.push({
        id: generateId(),
        name: input.value.trim(),
        laps: 0,
        inProgress: false
      });
      input.value = '';
      saveData();
      renderTasks();
    };

    // 汎用化したボタンアクション
    window.toggleProgress = function (event, taskId, subjectId) {
      if (event) event.stopPropagation();
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === (subjectId || currentSubjectId));
      const task = subject.tasks.find(t => t.id === taskId);
      task.inProgress = !task.inProgress;
      saveData();
      if (document.getElementById('view-subjects').classList.contains('active')) renderSubjects();
      else renderTasks();
    };

    window.addLap = function (event, taskId, subjectId) {
      if (event) event.stopPropagation();
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === (subjectId || currentSubjectId));
      const task = subject.tasks.find(t => t.id === taskId);
      task.laps += 1;
      task.inProgress = false;
      saveData();
      if (document.getElementById('view-subjects').classList.contains('active')) renderSubjects();
      else renderTasks();
    };

    window.removeLap = function (event, taskId, subjectId) {
      if (event) event.stopPropagation();
      const test = appData.find(t => t.id === currentTestId);
      const subject = test.subjects.find(s => s.id === (subjectId || currentSubjectId));
      const task = subject.tasks.find(t => t.id === taskId);
      if (task.laps > 0) {
        task.laps -= 1;
        saveData();
        if (document.getElementById('view-subjects').classList.contains('active')) renderSubjects();
        else renderTasks();
      }
    };

    // 初期描画
    renderTests();
  </script>
</body>

</html>
